= Redeem Session Token

include::plantuml/endpoint-mappings-session-redeemtoken-sequence.puml[]

GGO: `/v1.0/session/redeemtoken` +
Lithium: N/A

NOTE: Implemented in link:https://gitlab.com/playsafe/lithium/app-lithium-full/-/blob/develop/service-casino/service-casino-provider-iforium/src/main/java/lithium/service/casino/provider/iforium/controller/SessionController.java[lithium.service.casino.provider.iforium.controller.SessionController]

This endpoint redeems a short-lived `sessionToken` for the actual `sessionKey` linked to a player's session. If an active session exists, additional player information will be returned.

[TIP]
--
The format of the `sessionToken` is `sessionKey`-`timestamp` - e.g. `54ad78cb-1802-4fe7-9b4a-cc5eb2337da6-179b2ad1b0e`.

The `timestamp` is validated to check that is within the TTL (60 seconds) and the `sessionKey` is then used to collate the necessary information and returned as part of the response payload.

Calling this endpoint will refresh the session - i.e. extend its expiration time.
--

.Example Extraction
[source,java]
--
    int idx = sessionToken.lastIndexOf("-");
    String wrappedSessionKey = sessionToken.substring(0, idx);
    String timestamp = sessionToken.substring(idx+1, sessionToken.length());
    long issued = Long.parseLong(timestamp,16);
    long elapsed = System.currentTimeMillis() - issued;
    System.out.println("Elapsed:" + elapsed + ", Valid:" + (elapsed <= TTL));
--
== Request

[options="header", cols="^.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| Authorization +
_(header)_
| Basic Auth.
| String
| N/A
| Basic YWNtZTphY21lc2VjcmV0

| PlatformKey +
_(body)_
| The platform key associated with the caller.
| String(4)
|
| Validate against config

| Sequence +
_(body)_
| A unique sequence number generated by the Gameflex Operator Wallet API integration.
| String(50)
| N/A
| Ignore

| Timestamp +
_(body)_
| A UTC Timestamp for the request.
| Date
| N/A
| Ignore

| SessionToken +
_(body)_
| Unique Session Token supplied by the Operator. The Session Token should be single use only for security.
| String(50)
|
|

| IPAddress +
_(body)_
| IP Address of the Player’s Browser on Game Launch.
| String
| N/A
| Ignore

|===

.Example Request:
[source,json]
----
{
    PlatformKey: "L100",
    Sequence: "bfced060-b167-431e-bb84-023d8c31f53d",
    Timestamp: "2020-09-14T13:21:50.2518211Z",
    SessionToken: "20fbd3b9-eef2-49cd-9976-50f0d34e7f7c-179b2ad1b0e",
    IPAddress: "1.2.3.4"
}
----

== Response

[options="header", cols="^.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| ErrorCode
| Error Code.
| Integer
| N/A
| [0, -1, -3, -4, -5, -6]

| OperatorAccountID
| Unique identifier for the Player in the Operator Platform.
| String(50)
| LoginEvent.User.guid
|

| OperatorUserName
| [red]#*_Optional._*# The unique Username of Player inside the Operator Player. If an OperatorUserName is not specified, the Gameflex Platform will set this to the OperatorAccountID.
| String(50)
| LoginEvent.User.username
| Not returned.

| OperatorDisplayName
| [red]#*_Optional._*# A nickname for use in promotional facilities such as leader boards, etc.
| String(50)
| LoginEvent.User.externalUsername
| Not returned.

| CurrencyCode
| 3-character currency code in ISO 4217 format.
| String(3)
| LoginEvent.Domain.currency
|

| City
| [red]#*_Optional._*# The city / town of the Player’s address. Maybe be required by some Game Providers and some Regulated Markets.
| String(50)
| LoginEvent.city
| Not returned.

| CountryCode
| 2-character country code for the Player in ISO 3166 format.
| String(2)
| LoginEvent.countryCode
|

| DateOfBirth
| [red]#*_Optional._*# Player’s date of birth. Maybe be required by some Game Providers and some Regulated Markets.
| Date
| LoginEvent.User.getDateOfBirth()
| Not returned.

| Gender
| [red]#*_Optional._*# Gender of the Player. M for Male. F for Female. Maybe be required by some Game Providers and some Regulated Markets.
| Date
| LoginEvent.User.gender
| Not returned.

| GatewaySessionToken
| The Gateway Session Token should be a reference to the Player’s current session. The Gateway Session Token is then reposted into other API methods to keep the Player’s session alive. This should be a multi-use token.
| String(100)
| sessionKey
|

| Alerts
| [red]#*_Optional._*# Optional list of Alerts to be displayed to the Player before launching the Game.
| Alert[]
| N/A
| Ignore for now

|===

.Example Response:
[source,json]
----
{
    ErrorCode: 0,
    Result: {
        OperatorAccountID: "TestOperatorAccountID",
        OperatorUserName: "TestOperatorUserName",
        OperatorDisplayName: "TestOperatorDisplayName",
        CurrencyCode: "GBP",
        City: "Douglas",
        CountryCode: "GB",
        DateOfBirth: "1965-05-16T00:00:00",
        Gender: "M",
        GatewaySessionToken: "20fbd3b9-eef2-49cd-9976-50f0d34e7f7c"
    },
    Alerts: []
}
----
