= Place Bet

include::plantuml/endpoint-mappings-placebet-sequence.puml[]

GGO: `/v1.0/gameround/placebet` +
Lithium: `CasinoClientService.multiBetV1()`

NOTE: Implemented in link:https://gitlab.com/playsafe/lithium/app-lithium-full/-/blob/develop/service-casino/service-casino-provider-iforium/src/main/java/lithium/service/casino/provider/iforium/controller/GameRoundController.java[lithium.service.casino.provider.iforium.controller.GameRoundController]

== Request

[options="header", cols="<.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| Authorization +
_(header)_
| Basic Auth.
| String
| N/A
| Validate against config

| PlatformKey
| The platform key associated with the caller.
| String(4)
| N/A
| Validate against config

| GatewaySessionToken
| The Player’s current Gateway Session Token as returned from the Redeem Session Token method. This should be validated as active on Place Bet only.
| String(100)
| sessionKey
|

| Timestamp
| A UTC Timestamp for the request.
| Date
| BalanceAdjustmentRequest.ExternalTimestamp
| Ignore - issues with unique index in Lithium

| Sequence
| A unique sequence number generated by the Gameflex Operator Wallet API integration.
| String(50)
| N/A
| Ignore

| OperatorAccountID
| Unique identifier for the Player in the Operator Platform.
| String(50)
| BalanceAdjustmentRequest.UserGuid
|

| GameRoundID
| Unique Game Round ID within the Gameflex Platform.
| String(50)
| BalanceAdjustmentRequest.RoundId
|

| GameRoundTransactionID
| Unique identifier of the Game Round Transaction inside the Game Round.
| String(50)
| BalanceAdjustmentComponent.OperatorTransactionReference
|

| GameID
| Unique identifier of the Game being played inside the Game Round.
| String(50)
| BalanceAdjustmentRequest.GameGuid
|

| ContentGameProviderID
| Content Game Provider ID.
| String(50)
| N/A
| Ignore

| CurrencyCode
| Currency Code of the Transaction.
| String(3)
| BalanceAdjustmentRequest.CurrencyCode
|

| Amount
| This is the Operator Wallet Amount to be debited from the Operator Wallet. This will be zero for a Free Game and Game Providers can send through zero in other use cases.
| Decimal
| BalanceAdjustmentRequest.BalanceAdjustmentComponent.amount
|

| JackpotContribution
| Jackpot Contribution which can be up to 10 decimal places.
| Decimal
| N/A
| Ignore: not MVP

| FreeBetCost
| [red]#*_Optional._*# Free Bet Cost for Free Games. This amount should not be deducted from the Players funds and is for information only. Note, not all Game Providers provide Free Bet Costs.
| Money
| N/A
| Ignore: not MVP

| FreeBetOfferCode
| [red]#*_Optional._*# If the Game Round is for a Free Game, this is the promotional offer code associated with the Free Game.
| String(100)
| N/A
| Ignore: not MVP

| StartRound
| Indicates if the Place Bet is starting a new Game Round.
| Bool
|
| Check behaviour where StartRound is true but round already started

| EndRound
| Indicates if the Place Bet is ending the Game Round.
| Bool
| BalanceAdjustmentRequest.RoundFinished
|

|===

.Example Request:
[source,json]
----
{
    PlatformKey: "L100",
    Sequence: "dec51196-3a6b-4795-8653-1a4c2a6be08e",
    Timestamp: "2020-09-14T14:30:06.2794721Z",
    GatewaySessionToken: "cc146974-b210-482e-820b-771b01d15227",
    OperatorAccountID: "TestOperatorID",
    GameRoundID: "13245Z",
    GameRoundTransactionID: "123456Y",
    GameID: "11588",
    ContentGameProviderID: "12",
    CurrencyCode: "EUR",
    Amount: 1.23,
    JackpotContribution: 0,
    FreeBetCost: 0,
    FreeGameOfferCode: "OfferCode",
    StartRound: true,
    EndRound: false
}
----

include::endpoint-mappings-balanceadjustment-additional.adoc[leveloffset=+1]

== Response

[options="header", cols="<.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| ErrorCode
| Error Code.
| Integer
|
| [0, -1, -2, -3, -4, -5, -6, -9, -10, -11, -12, -13, -14]

| Balance
| The Operator Wallet Balance as described in link:endpoint-mappings-gameplay-balance.adoc[Get Balance]. The Operator Waller Balance should always be returned unless a catastrophic error has occurred, and the balance cannot be retrieved.
| Balance Object
|
|

| OperatorTransactionReference
| The unique identifier of the Game Round Transaction as assigned by the Operator Platform.
| String(50)
|
|

| OperatorTransactionSplit.BonusAmout
| The amount of funds debited from the Player’s Bonus Operator Wallet.
| Money
|
|

| OperatorTransactionSplit.CashAmount
| The amount of duns debited from the Player’s Cash Operator Wallet.
| Money
|
|

| Alerts
| [red]#*_Optional._*#  List of Alerts to be displayed to the Player after Place Bet.
| Alert[]
|
|

|===

.Example Response:
[source,json]
----
 {
    ErrorCode: 0,
    Balance: {
        CurrencyCode: "EUR",
        CashFunds: 210.71,
        BonusFunds: 0,
        FundsPriority: "Unknown",
        Version: 105657
    },
    Result: {
        OperatorTransactionReference: "B111",
        OperatorTransactionSplit: {
        BonusAmount: 0.22,
        CashAmount: 1.01 },
    },
    Alerts: []
}
----

== Comments

[quote]
--
It is recommended that the Stake, Wager, Loss and Session Limits are checked on receiving the first Bet for the Game Round to limit the number of incomplete Game Rounds for the Player. This should also increase overall Operator Wallet performance as fewer checks are being performed.
--

[IMPORTANT]
--
* The recorded effect for placebet should be `CASINO_BET(EBalanceAdjustmentAccountEffect.DEBIT, true)`
* Currency is not returned in the LoginEvent, which means we have to make a call to getBalance().
* Lithium doesn't support the concept of `startRound`, so edge-cases where `startRound` is sent against an already open or previously closed round will not result in error responses.
--
