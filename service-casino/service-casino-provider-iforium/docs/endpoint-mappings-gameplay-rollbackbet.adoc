= Rollback Bet

include::plantuml/endpoint-mappings-rollbackbet-sequence.puml[]

GGO: `/v1.0/gameround/rollbackbet` +
Lithium: `CasinoClientService.multiBetV1()`

NOTE: Implemented in link:https://gitlab.com/playsafe/lithium/app-lithium-full/-/blob/develop/service-casino/service-casino-provider-iforium/src/main/java/lithium/service/casino/provider/iforium/controller/GameRoundController.java[lithium.service.casino.provider.iforium.controller.GameRoundController]

== Request

[options="header", cols="^.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments


| Authorization +
_(header)_
| Basic Auth.
| String
| N/A
| Validate against config

| PlatformKey
| The platform key associated with the caller.
| String(4)
| N/A
| Validate against config

| GatewaySessionToken
| The Playerâ€™s current Gateway Session Token as returned from the Redeem Session Token method. This should be validated as active on Place Bet only.
| String(100)
| sessionKey
|

| Timestamp
| A UTC Timestamp for the request.
| Date
| BalanceAdjustmentRequest.ExternalTimestamp
| Ignore - issues with unique index in Lithium

| Sequence
| A unique sequence number generated by the Gameflex Operator Wallet API integration.
| String(50)
| N/A
| Ignore

| OperatorAccountID
| Unique identifier for the Player in the Operator Platform.
| String(50)
| BalanceAdjustmentRequest.UserGuid
|

| GameRoundID
| Unique Game Round ID within the Gameflex Platform.
| String(50)
| BalanceAdjustmentRequest.RoundId
|

| OriginalPlaceBetGameRoundTransactionID
| Unique identifier of the original Place Bet Game Round Transaction.
| String(50)
| BalanceAdjustmentRequest.BalanceAdjustmentComponent.reversalTransactionId
|

| GameRoundTransactionID
| Unique identifier of the Game Round Transaction inside the Game Round.
| String(50)
| BalanceAdjustmentComponent.OperatorTransactionReference
|

| GameID
| Unique identifier of the Game being played inside the Game Round.
| String(50)
| BalanceAdjustmentRequest.GameGuid
| Will need to have looked up lithium.service.games.client.objects.Game from the value provided in the request

| GameVersion
| Unique identifier of the Game being played inside the Game Round.
| String(100)
|
| [red]#*_Optional._*# Version number of the Game as required by some regulated markets. If not specified, a value of null will be sent.

| TableID
| Unique identifier of the Game being played inside the Game Round.
| String(50)
|
| [red]#*_Optional._*# Table ID sent by Live Dealer integrations only. If not specified, a value of null will be sent

| ContentGameProviderID
| Content Game Provider ID.
| String(50)
| N/A
| Ignore

| CurrencyCode
| Currency Code of the Transaction.
| String(3)
| BalanceAdjustmentRequest.CurrencyCode
|

| Amount
| This is the Operator Wallet Amount to be credited back to the Operator Wallet. The Amount should be considered as a stake rather than winnings. This can be zero for a Free Game and Game Providers can send through zero in other use cases.
| Decimal
| BalanceAdjustmentRequest.BalanceAdjustmentComponent.amount
|

| JackpotContribution
| [red]#*_Optional._*# Jackpot Contribution which can be up to 10 decimal places.
| Decimal
| N/A
| Ignore: not MVP

| FreeBetCost
| [red]#*_Optional._*# Free Bet Cost for Free Games. This amount should not be credited back to the Players funds and is for information only. Note, not all Game Providers provide Free Bet Costs.
| Money
| N/A
| Ignore: not MVP

| FreeBetOfferCode
| [red]#*_Optional._*# If the Game Round is for a Free Game, this is the promotional offer code associated with the Free Game.
| String(100)
| N/A
| Ignore: not MVP

| EndRound
| Indicates if the Rollback Bet is ending the Game Round.
| Bool
| BalanceAdjustmentRequest.RoundFinished
|

|===

.Example Request:
[source,json]
----
{
    PlatformKey: "L100",
    Sequence: "dec51196-3a6b-4795-8653-1a4c2a6be08e",
    Timestamp: "2020-09-14T14:30:06.2794721Z",
    GatewaySessionToken: "cc146974-b210-482e-820b-771b01d15227",
    OperatorAccountID: "TestOperatorID",
    GameRoundID: "13245Z",
    OrginalBetGameRoundTransactionID: "123456Y",
    GameRoundTransactionID: "123457Y",
    GameID: "11588",
    GameVersion: "V1.2.3.4",
    TableID: "T1234",
    ContentGameProviderID: "12",
    CurrencyCode: "EUR",
    Amount: 1.23,
    JackpotContribution: 0,
    FreeGameOfferCode: "OfferCode",
    EndRound: false
}
----

include::endpoint-mappings-balanceadjustment-additional.adoc[leveloffset=+1]

== Response

[options="header", cols="^.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| ErrorCode
| Error Code.
| Integer
|
| [0, -1, -5, -7, -8, -9, -14]

| Balance
| The Operator Wallet Balance as described in link:endpoint-mappings-gameplay-balance.adoc[Get Balance]. The Operator Waller Balance should always be returned unless a catastrophic error has occurred, and the balance cannot be retrieved.
| Balance Object
|
|

| OperatorTransactionReference
| The unique identifier of the Game Round Transaction as assigned by the Operator Platform.
| String(50)
|
|

|===

.Example Response:
[source,json]
----
{
    ErrorCode: 0,
    Balance: {
        CurrencyCode: "EUR",
        CashFunds: 210.71,
        BonusFunds: 0,
        FundsPriority: "Unknown",
        Version: 105657
    },
    Result: {
        OperatorTransactionReference: "B111"
    }
}
----

== Comments

[quote]
--
The Rollback Bet method is used to rollback a Place Bet within the Game Round when an unknown error or timeout occurs from the Operator Wallet API. A rollback can also be signalled by the Game Provider. If the Original Place Bet is found, then the Operator Platform should rollback the original stake in the form of credit to the Operator Wallet. If the Original Place Bet is not found, no adjustment should be made. Note, a rollback of a bet can occur after the Game Round has ended.
--

[IMPORTANT]
--
* The recorded effect for rollbackbet should be `CASINO_BET_REVERSAL(EBalanceAdjustmentAccountEffect.CREDIT, false)`
* No session checks should be performed.
 `OriginalPlaceBetGameRoundTransactionID` is mis-spelt in the API document
--
