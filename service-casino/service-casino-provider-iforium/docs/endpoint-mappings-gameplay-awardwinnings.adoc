= Award Winnings

include::plantuml/endpoint-mappings-awardwinnings-sequence.puml[]

GGO: `/v1.0/gameround/awardwinnings` +
Lithium: `CasinoClientService.multiBetV1()`

NOTE: Implemented in link:https://gitlab.com/playsafe/lithium/app-lithium-full/-/blob/develop/service-casino/service-casino-provider-iforium/src/main/java/lithium/service/casino/provider/iforium/controller/GameRoundController.java[lithium.service.casino.provider.iforium.controller.GameRoundController]

== Request

[options="header", cols="^.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| Authorization +
_(header)_
| Basic Auth.
| String
| N/A
| Validate against config

| PlatformKey
| The platform key associated with the caller.
| String(4)
| N/A
| Validate against config

| GatewaySessionToken
| [red]#*_Optional._*# The Player’s current Gateway Session Token as returned from the Redeem Session Token method.
| String(100)
| sessionKey
| Do not validate

| Timestamp
| A UTC Timestamp for the request.
| Date
| BalanceAdjustmentRequest.ExternalTimestamp
| Ignore - issues with unique index in Lithium

| Sequence
| A unique sequence number generated by the Gameflex Operator Wallet API integration.
| String(50)
| N/A
| Ignore

| OperatorAccountID
| Unique identifier for the Player in the Operator Platform.
| String(50)
| BalanceAdjustmentRequest.UserGuid
|

| GameRoundID
| Unique Game Round ID within the Gameflex Platform.
| String(50)
| BalanceAdjustmentRequest.RoundId
|

| GameRoundTransactionID
| Unique identifier of the Game Round Transaction inside the Game Round.
| String(50)
| BalanceAdjustmentComponent.OperatorTransactionReference
|

| GameID
| Unique identifier of the Game being played inside the Game Round.
| String(50)
| BalanceAdjustmentRequest.GameGuid
|

| ContentGameProviderID
| Content Game Provider ID.
| String(50)
| N/A
| Ignore

| CurrencyCode
| Currency Code of the Transaction.
| String(3)
| BalanceAdjustmentRequest.CurrencyCode
|

| Amount
| This is the Amount to be credited to the Players Operator Wallet. This can be zero for some Game Providers. If it’s a Free Game, then the Free Game winnings will be included in this Amount.
| Decimal
| BalanceAdjustmentRequest.BalanceAdjustmentComponent.amount
|

| JackpotWinnings
| [red]#*_Optional._*# The Jackpot Winnings awarded. Note, this is for information only and is used to calculate revenue; only the Amount should be credited to the Player Operator Wallet. The Jackpot Winnings amount can be the same as the Amount or less than the Amount.
| Decimal
| N/A
| Ignore: not MVP

| FreeBetOfferCode
| [red]#*_Optional._*# If the Game Round is for a Free Game, this is the promotional offer code associated with the Free Game.
| String(100)
| N/A
| Ignore: not MVP

| StartRound
| Indicates if the Award Winnings is starting a new Game Round.
| Bool
|
| Check behaviour where StartRound is true but round already started

| EndRound
| Indicates if the Award Winnings is ending the Game Round.
| Bool
| BalanceAdjustmentRequest.RoundFinished
|
|===

.Example Request:
[source,json]
----
{
    PlatformKey: "L100",
    Sequence: "dec51196-3a6b-4795-8653-1a4c2a6be08e",
    Timestamp: "2020-09-14T14:30:06.2794721Z",
    GatewaySessionToken: "cc146974-b210-482e-820b-771b01d15227",
    OperatorAccountID: "TestOperatorID",
    GameRoundID: "13245Z",
    GameRoundTransactionID: "123456Y",
    GameID: "11588",
    ContentGameProviderID: "12",
    CurrencyCode: "EUR",
    Amount: 1.23,
    JackpotWinnings: 0,
    FreeGameOfferCode: "OfferCode",
    StartRound: true,
    EndRound: false
}
----

== Response

[options="header", cols="^.<20m,.<30,.<10,.<20m,.<20e"]
|===
|GGO Parameter|Description|Type|Lithium Parameter|Comments

| ErrorCode
| Error Code.
| Integer
|
| [0, -1, -5, -6, -7, -9]

| Balance
| The Operator Wallet Balance as described in link:endpoint-mappings-gameplay-balance.adoc[Get Balance]. The Operator Waller Balance should always be returned unless a catastrophic error has occurred, and the balance cannot be retrieved.
| Balance Object
|
|

| OperatorTransactionReference
| The unique identifier of the Game Round Transaction as assigned by the Operator Platform.
| String(50)
|
|

| Alerts
| [red]#*_Optional._*#  List of Alerts to be displayed to the Player after the Award Winnings.
| Alert[]
|
|

|===

.Example Response:
[source,json]
----
{
    ErrorCode: 0,
    Balance: {
        CurrencyCode: "GBP",
        CashFunds: 120.15,
        BonusFunds: 30.1,
        FundsPriority: "Unknown",
        Version: 1234
    },
    Result: {
        OperatorTransactionReference: "B111"
    },
    Alerts: []
}
----

== Comments

[IMPORTANT]
--
* The recorded effect for `/awardwinnings` depends on whether or not the `amount` is zero and whether or not `RoundFinished` is true:
** If `amount` is *zero* _and_ `RoundFinished` is *true*, then: `CASINO_LOSS(EBalanceAdjustmentAccountEffect.DEBIT, false)`
** If `amount` is _not_ *zero* _or__ `RoundFinished` is *false*, then: `CASINO_WIN(EBalanceAdjustmentAccountEffect.CREDIT, false)`
* The Award Winnings must be idempotent e.g. the Award Winnings can be retried multiple times by the Gameflex Platform with the same `GameRoundTransactionID` until a success response is received. This can be retried offline; therefore, no session checks should be performed. Note, each retry will have a different `Timestamp` and `Sequence` from the original Award Winnings request.
* The current Operator Wallet Balance must always be returned from the Operator Wallet, not the balance when the action was originally processed.
--
