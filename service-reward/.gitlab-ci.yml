.job_template: &createdockerimages
  stage: createdockerimages
  image: registry.gitlab.com/playsafe/docker/maven-docker-builder:openjdk17
  cache:
    key: app-lithium-full-maven-cache-no-lithium
    paths:
      - repository
  except:
    - develop
    - schedules
  services:
    - docker:dind

.job_template: &createdockerimages_all
  stage: createdockerimages
  image: registry.gitlab.com/playsafe/docker/maven-docker-builder:openjdk17
  when: manual
  cache:
    key: app-lithium-full-maven-cache-no-lithium
    paths:
      - repository
  except:
    - develop
    - schedules
  services:
    - docker:dind
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[all\]/

.job_template: &deploy
  stage: deploy
  image: registry.gitlab.com/playsafe/docker/lithium-deployer:latest
  environment:
    name: $CI_COMMIT_REF_NAME
  except:
    - develop
    - schedules
  # only:
  #   refs:
  #     - /^environment/.*$/

.job_template: &deploy_all
  stage: deploy
  image: registry.gitlab.com/playsafe/docker/lithium-deployer:latest
  when: manual
  environment:
    name: $CI_COMMIT_REF_NAME
  # except:
  #   - develop
  #   - schedules
  only:
    refs:
      - /^environment/.*$/
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[all\]/

svc-reward:createdockerimage:
  <<: *createdockerimages
  script: "sh build/gitlab/build-image.sh svc-reward service-reward/service-reward"
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[service-reward\]/

svc-reward:createdockerimage_all:
  <<: *createdockerimages_all
  script: "sh build/gitlab/build-image.sh svc-reward service-reward/service-reward"

svc-reward:deploy:
  <<: *deploy
  script: "bash build/gitlab/deploy.sh svc-reward"
  only:
    refs:
      - /^environment/.*$/
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[service-reward\]/

svc-reward:deploy_all:
  <<: *deploy_all
  script: "bash build/gitlab/deploy.sh svc-reward"

svc-reward-pr-casino-roxor:createdockerimage:
  <<: *createdockerimages
  script: "sh build/gitlab/build-image.sh svc-reward-pr-casino-roxor service-reward/service-reward-provider-casino-roxor"
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[service-reward-provider-casino-roxor\]/

svc-reward-pr-casino-roxor:createdockerimage_all:
  <<: *createdockerimages_all
  script: "sh build/gitlab/build-image.sh svc-reward-pr-casino-roxor service-reward/service-reward-provider-casino-roxor"

svc-reward-pr-casino-roxor:deploy:
  <<: *deploy
  script: "bash build/gitlab/deploy.sh svc-reward-pr-casino-roxor"
  only:
    refs:
      - /^environment/.*$/
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[service-reward-provider-casino-roxor\]/

svc-reward-pr-casino-roxor:deploy_all:
  <<: *deploy_all
  script: "bash build/gitlab/deploy.sh svc-reward-pr-casino-roxor"

svc-reward-pr-casino-blueprint:createdockerimage:
  <<: *createdockerimages
  script: "sh build/gitlab/build-image.sh svc-reward-pr-casino-blueprint service-reward/service-reward-provider-casino-blueprint"
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[service-reward-provider-casino-blueprint\]/

svc-reward-pr-casino-blueprint:createdockerimage_all:
  <<: *createdockerimages_all
  script: "sh build/gitlab/build-image.sh svc-reward-pr-casino-blueprint service-reward/service-reward-provider-casino-blueprint"

svc-reward-pr-casino-blueprint:deploy:
  <<: *deploy
  script: "bash build/gitlab/deploy.sh svc-reward-pr-casino-blueprint"
  only:
    refs:
      - /^environment/.*$/
    variables:
      - $CI_COMMIT_MESSAGE =~ /\[service-reward-provider-casino-blueprint\]/

svc-reward-pr-casino-blueprint:deploy_all:
  <<: *deploy_all
  script: "bash build/gitlab/deploy.sh svc-reward-pr-casino-blueprint"
