<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <title>Deposit Details</title>
    <style>*,*::after,*::before{box-sizing:border-box}html{padding:1rem;background-color:#FFF;font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif}#payment-form{width:31.5rem;margin:0 auto}iframe{width:100%}.one-liner{display:flex;flex-direction:column}#pay-button{border:none;border-radius:3px;color:#FFF;font-weight:500;height:40px;width:100%;background-color:#13395E;box-shadow:0 1px 3px 0 rgba(19,57,94,0.4)}#pay-button:active{background-color:#0B2A49;box-shadow:0 1px 3px 0 rgba(19,57,94,0.4)}#pay-button:hover{background-color:#15406B;box-shadow:0 2px 5px 0 rgba(19,57,94,0.4)}#pay-button:disabled{background-color:#697887;box-shadow:none}#pay-button:not(:disabled){cursor:pointer}.card-frame{border:solid 1px #13395E;border-radius:3px;width:100%;margin-bottom:8px;height:40px;box-shadow:0 1px 3px 0 rgba(19,57,94,0.2)}.card-frame.frame--rendered{opacity:1}.card-frame.frame--rendered.frame--focus{border:solid 1px #13395E;box-shadow:0 2px 5px 0 rgba(19,57,94,0.15)}.card-frame.frame--rendered.frame--invalid{border:solid 1px #D96830;box-shadow:0 2px 5px 0 rgba(217,104,48,0.15)}.success-payment-message{color:#13395E;line-height:1.4}.token{color:#b35e14;font-size:0.9rem;font-family:monospace}@media screen and (min-width: 31rem){.one-liner{flex-direction:row}.card-frame{width:318px;margin-bottom:0}#pay-button{width:175px;margin-left:8px}}</style>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
          integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
    <style>
        body { margin-top:20px; }
        .credit-card-box .panel-title {
            display: inline;
            font-weight: bold;
        }
        .credit-card-box label {
            display: block;
        }
        .credit-card-box .display-tr {
            display: table-row;
        }
        .credit-card-box .display-td {
            display: table-cell;
            vertical-align: middle;
            width: 100%;
        }
        .credit-card-box .panel-heading img {
            min-width: 180px;
        }
        input[type='radio'] {
            transform: scale(1.2);
        }
        .modal-dialog {
            position:absolute;
            top:50% !important;
            transform: translate(0, -50%) !important;
            -ms-transform: translate(0, -50%) !important;
            -webkit-transform: translate(0, -50%) !important;
            margin:auto 5%;
            width:90%;
        }
        .modal-header {
            border-bottom: none;
        }

        #overlay {
            background: #ffffff;
            color: #666666;
            position: fixed;
            height: 100%;
            width: 100%;
            z-index: 5000;
            top: 0;
            left: 0;
            float: left;
            text-align: center;
            padding-top: 25%;
            opacity: .80;
        }
        .spinner {
            margin: 0 auto;
            height: 64px;
            width: 64px;
            animation: rotate 0.8s infinite linear;
            border: 5px solid firebrick;
            border-right-color: transparent;
            border-radius: 50%;
        }
        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        #confirm_form {
            width:31.5rem;margin:0 auto
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
<!-- add frames script -->
<script src="https://cdn.checkout.com/js/framesv2.min.js"></script>

<div id="overlay" style="display:none;">
    <div class="spinner"></div>
    <br/>
    Loading...
</div>

<div class="container">
    <div class="row">
        <div class="col-xs-12 col-md-12">
            <div class="panel panel-default credit-card-box">
                <div class="panel-heading display-table">
                    <div class="row display-tr">
                        <h3 class="panel-title display-td">Deposit Details</h3>
                        <div class="display-td">
                            <img class="img-responsive pull-right" th:src="@{cards.png}"></img>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <form role="form" id="payment-form" method="POST" action="deposit/do" th:action="@{deposit/do}" th:object="${deposit}">
                        <input id="token" name="token" type="hidden"/>

                        <div class="form-group" th:if="${!deposit.userCards.isEmpty()}">
                            <label>Payment method</label>
                            <div th:each="card,stat : ${deposit.userCards}">
                                <div class="row">
                                    <div class="col-xs-1 col-md-1">
                                        <input type="radio" th:id="${'used_card'+ stat.index}" name="used_card" th:value="${card.getReference()}" th:checked="${card.getIsDefault()}"/>
                                    </div>
                                    <div class="col-xs-10 col-md-10">
                                        <label th:for="${'used_card'+ stat.index}" th:text="${card.getScheme() + ' ending in  ' + card.getLastFourDigits() + ' (expires ' + card.getExpiryDate() + ')' }">Card</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label for="amount">AMOUNT</label>
                                    <div class="input-group">
                                        <input required="true" type="number" value="100.00" min="1.00" step=".01" class="form-control" id="amount" name="amount"> </input>
                                        <span class="input-group-addon"><i class="fa fa-money"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" th:if="${deposit.userCards.isEmpty()}">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label for="nameoncard">Name on your card</label>
                                    <input class="form-control" th:value="${deposit.userFullName}" id="nameoncard" name="nameoncard"></input>
                                </div>
                            </div>
                        </div>
                        <div class="row" th:if="${deposit.userCards.isEmpty()}">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <label for="cardNumber">CARD NUMBER</label>
                                    <div class="input-group">
                                        <div class="card-number-frame form-control" id="cardNumber"> </div>
                                        <span class="input-group-addon"><i id="cardNumberIcon" class="fa fa-credit-card"></i></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row" th:if="${deposit.userCards.isEmpty()}">
                            <div class="col-xs-7 col-md-7">
                                <div class="form-group">
                                    <label for="cardExpiry"><span class="hidden-xs">EXPIRATION</span><span class="visible-xs-inline">EXP</span> DATE</label>
                                    <div class="expiry-date-frame form-control" id="cardExpiry"
                                    ></div>
                                </div>
                            </div>
                            <div class="col-xs-5 col-md-5 pull-right">
                                <div class="form-group">
                                    <label for="cardCVC">CVV</label>
                                    <div class="cvv-frame form-control" id="cardCVC"></div>
                                </div>
                            </div>
                        </div>
                        <div class="row" th:if="${!deposit.userCards.isEmpty()}">
                            <div class="col-xs-12">
                                <div class="form-group">
                                    <a class="btn btn-default btn-block" th:href="@{''(newCard=true)}" role="button">New card</a>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="row">
                        <div class="col-xs-12">
                            <button id="pay-button" disabled="true" class="pay btn btn-success btn-lg btn-block" type="button">Deposit</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModal4">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h4 class="modal-title">Enter security number</h4>
                    <span>* 3 digits on the back of your card</span>

                </div>
                <div class="modal-body">
                    <div class="container">
                        <form method="POST" id="confirm_form" action="deposit/do" th:action="@{deposit/do}" th:object="${deposit}">
                            <input id="confirm_card_ref" name="used_card" type="hidden"/>
                            <input id="confirm_amount" name="amount" type="hidden"/>
                            <div class="row">
                                <div class="col-xs-8 col-md-8">
                                    <span id="cardRef"></span>
                                </div>
                                <div class="col-xs-4 col-md-4 pull-right">
                                    <div class="form-group">
                                        <label for="cardCVC">CVV</label>
                                        <input type="number" name="cvv"
                                               oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
                                               pattern="^[0-9]{3, 4}$"
                                               maxlength = "4" id="cardCVCmodal" class="form-control"></input>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-xs-12 col-md-12">
                                    <div class="form-group">
                                      <button id="confirm_btn" disabled="true" class="btn btn-success btn-lg btn-block" data-dismiss="modal">Confirm Deposit</button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script th:inline="javascript">
//<![CDATA[
    var $form = $('#payment-form');
    var confirmForm = $('#confirm_form');
    var payButton = $('#pay-button');
    var useNewCard = [[${deposit.userCards.isEmpty()}]];
    var publicKey = [[${deposit.publicKey}]];
    var ammountSelector = $("#payment-form input[name='amount']");
    var nameSelector = $("#payment-form input[name='nameoncard']");


    if (useNewCard) {
        Frames.init(publicKey);
    }

    Frames.addEventHandler(
        Frames.Events.CARD_VALIDATION_CHANGED,
        function (event) {
            console.log("CARD_VALIDATION_CHANGED: %o", event);
            validateForm();
        }
    );

    Frames.addEventHandler(
        Frames.Events.CARD_TOKENIZED,
        function (event) {
            $('#overlay').fadeIn();
            $form.find('#token').val(event.token);
            $form.submit();
        }
    );

    Frames.addEventHandler(
        Frames.Events.PAYMENT_METHOD_CHANGED,
        function (event) {
            var pm = event.paymentMethod;
            if (pm) {
                showPaymentMethodIcon(pm);
            } else {
                clearPaymentMethodIcon();
            }
        }
    );

    function showPaymentMethodIcon(pm) {
        if (pm) {
            console.log(pm);
            switch (pm.toLowerCase()) {
                case "mastercard":
                    $form.find($("#cardNumberIcon")).removeClass('fa-credit-card').addClass('fa-cc-mastercard');
                    break;
                case "visa":
                    $form.find($("#cardNumberIcon")).removeClass('fa-credit-card').addClass('fa-cc-visa');
                    break;
            }
        }
    }

    function clearPaymentMethodIcon(parent) {
        $form.find($("#cardNumberIcon")).removeClass().addClass('fa fa-credit-card');
    }


    Frames.addEventHandler(Frames.Events.FRAME_VALIDATION_CHANGED, onValidationChanged );

    function onValidationChanged(event) {
        var e = event.element;
        if (event.isValid || event.isEmpty) {
            if (e === "card-number" && !event.isEmpty) {
                showPaymentMethodIcon();
            }
            //clearErrorMessage(e);
        } else {
            if (e === "card-number") {
                clearPaymentMethodIcon();
            }
            //setErrorMessage(e);
        }
    }

    payButton.bind("click", function (event) {
        if (useNewCard) {
            event.preventDefault();
            Frames.cardholder.name = nameSelector.val();
            Frames.submitCard();
        } else {
            $('#myModal4').modal({
                backdrop: 'static',
                keyboard: false,
                show: true
            })
            //$form.submit();
        }
        $(this).prop('disabled', true);
    });

    validateForm();

    ammountSelector.change(validateForm);

    function validateForm() {
        var disabled = true;
        if (ammountSelector.val() && ammountSelector.val().length >= 1) {
            if (useNewCard) {
                disabled = !Frames.isCardValid();
            } else {
                disabled = false;
            }
        } else {
            disabled = true;
        }
        payButton.prop('disabled', disabled);
    };

    $("#confirm_form input[name='cvv']").change(function() {
        if (this.value && this.value.length >= 3 && this.value.length <= 4  ) {
            $('#confirm_btn').prop('disabled', false);
        } else {
            $('#confirm_btn').prop('disabled', true);
        }
    });

    $('#confirm_btn').bind("click", function () {

        $('#overlay').fadeIn();
        confirmForm.submit();
    });

    $('#myModal4').on('show.bs.modal', function () {
        $('#confirm_card_ref').val($("input[type='radio'][name='used_card']:checked").val());
        $('#cardRef').text($("input[type='radio'][name='used_card']:checked").parent().next().find('label').text());
        $('#confirm_amount').val($("#payment-form input[name='amount']").val());
    });

    $('#myModal4').on('hide.bs.modal', function () {
        validateForm();
    });

//]]>
</script>
</body>
</html>
